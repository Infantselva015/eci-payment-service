apiVersion: v1
kind: ConfigMap
metadata:
  name: payment-db-init
data:
  init.sql: |
    -- Payment Service Database Schema

    -- Create payments table
    CREATE TABLE IF NOT EXISTS payments (
        payment_id SERIAL PRIMARY KEY,
        order_id INTEGER UNIQUE NOT NULL,
        user_id INTEGER NOT NULL,
        amount NUMERIC(10, 2) NOT NULL,
        currency VARCHAR(3) DEFAULT 'INR',
        payment_method VARCHAR(20) NOT NULL,
        status VARCHAR(20) DEFAULT 'PENDING',
        transaction_id VARCHAR(50) UNIQUE,
        gateway_response VARCHAR(500),
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        completed_at TIMESTAMP
    );

    -- Create transactions table
    CREATE TABLE IF NOT EXISTS transactions (
        transaction_log_id SERIAL PRIMARY KEY,
        payment_id INTEGER NOT NULL REFERENCES payments(payment_id) ON DELETE CASCADE,
        transaction_type VARCHAR(20) NOT NULL,
        amount NUMERIC(10, 2) NOT NULL,
        status VARCHAR(20) NOT NULL,
        description VARCHAR(500),
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    -- Create indexes
    CREATE INDEX IF NOT EXISTS idx_payments_order_id ON payments(order_id);
    CREATE INDEX IF NOT EXISTS idx_payments_user_id ON payments(user_id);
    CREATE INDEX IF NOT EXISTS idx_payments_status ON payments(status);
    CREATE INDEX IF NOT EXISTS idx_payments_transaction_id ON payments(transaction_id);
    CREATE INDEX IF NOT EXISTS idx_transactions_payment_id ON transactions(payment_id);
